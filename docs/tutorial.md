# Parts required
## Pedalboard
I've included shipping costs as often this is a greater cost than the actual part ordered from AliExpress. You can load an image of the part from the link in description.

Prices will vary, only here as a guide on what to expect.

| Type                            |                                                      Count | Description                                                                                                                                            | Price ($AUD) |
| ------------------------------- | ---------------------------------------------------------: | ------------------------------------------------------------------------------------------------------------------------------------------------------ | -----------: |
| Enclosure                       |                                                          1 | [Hammond 1456RL1BKBU from mouser.com](hammond.png)                                                                                                     |       $71.70 |
| Arduino                         |                                                          1 | [Work Good DUE R3 Board AT91SAM3X8E SAM3X8E 32-bit ARM Cortex-M3 Control Board Module For Arduino](arduino_due.png)                                    |       $19.49 |
| TFT Screen                      |                                                         15 | [1.8 Inch TFT Color Screen LCD Display Module Drive ST7735](tft_screen.png)                                                                            |       $69.35 |
| Footswitch                      |                                                         15 | [1pcs SPST Momentary Soft Touch Push Button Stomp Foot Pedal Switch Electric Guitar Switch OFF-Momentary ON](footswitch.png)                           |       $40.42 |
| DC Socket                       |                                                          1 | [3A 12v For DC Power Supply Jack Socket Female Panel Mount Connector 5.5mm 2.1mm Plug Adapter 2 Terminal Types 5.5*2.1](dc_socket.png) (1)             |        $1.37 |
| USB Socket                      |                                                          1 | [Micro USB USB 2.0 Male Connector To Micro USB 2.0 Female Extension Cable 30cm 50cm With Screws Panel Mount Hole](usb_socket.png)                      |        $4.36 |
| Pin headers                     |                                              2(10pc total) | [5pcs Pins Multipurpose: Male- 10pcs 40 Pin 1x40 Single Row Male Breakable Pin Header Connector Strip for Arduino](pin_headers.png)                    |        $3.01 |
| PCB board                       |                                                          2 | [5x7cm 5*7 Double Side Prototype PCB diy Universal Printed Circuit Board](pcb_board.png) (2 used)                                                      |        $4.84 |
| Dupont cables                   |                                                          2 | [120PCS 40PIN 20CM Dupont line male to male + female and female to female bridge Dupont Wire Cable for Arduino DIY KIT](dupont.png) (Get all variants) |        $5.98 |
| DIN socket                      |                                               1 (1 needed) | [10PCS 3/4/5/6/7/8PIN Panel Mount Female Jack DIN Adapter MIDI Cable Connector](din_socket.png) (1 for pedalboard)                                     |        $6.16 |
| Heatshrink                      |                                                          2 | [5 METER/LOT BLACK 1mm 1.5mm 2mm 2.5mm 3mm 3.5mm 4mm 5mm 6mm Heat Shrink Tubing Tube](heatshrink.png) (10m required)                                   |        $2.92 |
| Breadboard                      |                                                          1 | [MB102 Breadboard Power Module+MB-102 830 Points Solderless Prototype Bread Board](breadboard.png)                                                     |        $2.38 |
| Plastic Nuts                    |                                            2 (~160 needed) | [100pcs/lot M2 M2.5 M3 M4 M5 M6 M8 M10 Black or white Nylon Hex Nut Hexagon Plastic Nuts](plastic_nut.png) (M3)                                        |        $9.26 |
| M3 screws                       |                                                          2 | [50PCS ISO7380 black button head screw M2 M2.5 M3 M4 M5 M6 M8 Hexagon Socket round head Screws Hex Socket Screw](screws.png) **(M3 20mm)**             |        $7.64 |
| M3 screws                       |                                                          1 | [50PCS ISO7380 black button head screw M2 M2.5 M3 M4 M5 M6 M8 Hexagon Socket round head Screws Hex Socket Screw](screws.png) **(M3 50mm)**             |           $4 |
| Exp 1/4" TRS Socket             |                                                          2 | [6.5MM CHASSIS SOCKET STEREO/SWITCHED](trs_socket.png)                                                                                                 |        $4.02 |
| Wire                            |  | Get multi-color 22AWG ideally 8 different colours 25m each?                                                                                                                                                      |
| Latching switch (power button)  | 1 | [SPST Latching](switch_latching.png) | $3                                                                                                                                                     |
| Momentary switch (reset switch) | 1 |[SPST Momentary](switch_momentary.png) | $3                                                                                                                                                     |
| Resistor 220ohm                   |4 | Resistors for midi circuit 
| Resistor 120ohm                   |1| Resistor for tempo LED 
| 2mm Red LED                       |1| LED for tempo flash      

Notes:
* The dupont cables and breadboard are optional as they are used for testing.
* The TRS sockets must be switched - meaning when you plug the cable in it lifts 1 contact off another. This allows the analog inputs to be grounded when the cable is unplugged (more on this later in the tutorial)
* TRS sockets - you need as many as the number of expression pedals you want to run
* Plastic nuts - it's important not to use metal as they will be used in places that may short a circuit

## Midi power box
| Type       |        Count | Description                                                                                                                                                       | Price ($AUD) |
| ---------- | -----------: | ----------------------------------------------------------------------------------------------------------------------------------------------------------------- | -----------: |
| Enclosure  |            1 | [22 Sizes Top Quality ABS Plastic Waterproof Cover Project Electronic Project Box Instrument Case Enclosure Boxes 8 Sizes](enclosure_midi.png) (black 82x52x35mm) |              |
| DC Socket  |            1 | [3A 12v For DC Power Supply Jack Socket Female Panel Mount Connector 5.5mm 2.1mm Plug Adapter 2 Terminal Types 5.5*2.1](dc_socket.png) (1)                        |        $0.00 |
| DIN socket | 1 (3 needed) | [10PCS 3/4/5/6/7/8PIN Panel Mount Female Jack DIN Adapter MIDI Cable Connector](din_socket.png) (7 pin)                                                           |        $0.00 |

Sourced pretty much everything else off aliexpress, I'll provide descriptions so hopefully a search will find the right things (in case my links don't work).
Switches: 1pcs SPST Momentary Soft Touch Push Button Stomp Foot Pedal Switch Electric Guitar Switch OFF-Momentary ON
Screens: 1.8" TFT SPI ST7735

# Tools
I won't list prices / specifics here, just generally what you will need.

* Dremel/Rotary tool + 5-10 cut off wheels (anything appropriate for metal cutting - perhaps invest in durable cutters)
* N95 respirator (Essential when cutting aluminium with power tools) 
* Protective glasses
* Allen keys / Screw drivers for screws
* Wire strippers
* Soldering station
* A lot of solder (narrow)...
* Spanner
* Drill bit set
* Stepped drill bits or hole saws for cutting holes big enough for DIN sockets

# Software
Install FreeCad (I used version 0.18)

# Part 1 - Enclosure preparation
## Preparation
We will be using a rotary tool to cut out the square holes. To have a stronger solution we need to drill the corners of the squares first and then cut between them. So we want to start by marking out the corners of the screens on the face of the enclosure - use a center punch if you have 1 or mark with pencil / other marker.  

Open docs/PedalBoard.FCStd in FreeCad to get an overview of the board and where the footswitches / screens will be placed. 
Open screen.FCStf and then double-click screen/Body/Pad001/Sketch to see the detailed sketch. The inner block is the screen section that should be visible and will be the size of the hole we make in the enclosure.
The dimensions of the screen are 35.04mm x 28.03mm. It's also worth noting that the bottom left start of the screen is 6mm above and 2.985mm to the right of the bottom left of the screen board.
You can choose to divide up the space for your screens / switches yourself or you can use exact placement from the CAD design. To use exact placement:
* Select the top down view in FreeCard for the PedalBoard model
* Select the face of a screen and then view the 'Placement'. [Screenshot](screen_placement.png)
* You can now add these numbers together to get an X,Y position for the first screen:
  1. 54.44mm,67.725mm 
  2. 89.48mm,67.725mm
  3. 89.48mm,85.755mm
  4. 54.44mm,85.755mm
* You can repeate this process for every screen and record the co-ordinates in excel (use a basic function to calculate the wholes for each screen). Or you can find your own method :)
* For the footswitches we just need to find a center point to drill out
* Use the same method for the footswitches however this is much easier as you can just use an X co-ordinate of the screen X1 + (35.04 / 2). The Y co-ordinate can be Y1 - C where C is a constant value of 22.3mm
  
We now need to mark the positions for the arduino, PCB boards and other ports
* I mounted 2 PCB boards either side of the screens. See [photo](enclosure_inside_pcb.png)
* You can lay the PCB flat on the encsloure and center punch through the board holes
* This can be repeated for the arduino as well. The Arduino Due has 6 holes tht should be marked
* For other components I just placed these roughly - dc power, 1 DIN, 2 TRS sockets (for expression pedals), 1 reset switch. [Photo](back_components.png)

## Cutting, Drilling etc
Important: You should wear the N95 respirator + safety glasses as this stage - particularly when cutting aluminium as it creates a fine dust that will destroy your lungs.

* The screen corner holes can now be drilled with a small drill bit (2mm or less).
* Use the rotary tool with metal cutting disc attachment to cut between the drill holes
* Use a file, followed by sandpaper (anything around 100 grit will be fine) to clean up cuts and remove any sharp edges
* Use a drill to create a pilot hole for the footswitches and other components and then use the stepped drill bit to increase size until component fits - have a component handy to test as you cut
* Use a 1.5mm drill bit to create a hole for the led (that shows tempo time)
  * Use the led to test for appropriate size here. Use super glue to attach the led in place

## Extra support
I found that after removing the material for the screens the enclosure had become weaker so using footswitches would bow the top panel. I've addressed this to an acceptable level by adding some extra brackets to support the top panel. [Photo](bottom_panel.png)
I won't go into detail on this as you will need to place these according to your specific enclosure. The brackets can be found at any hardward store.

You should now have your enclosure prepared ready for assembly.


# Assembly
# PCB boards
Use long m3 screws through the enclosure into the PCB board. My boards had a tight thread so I did not need to use a nut on top to hold in place. However I did need a nut against the enclosure to keep the PCB in place. [photo](enclosure_inside_pcb.png)

These boards will actually be soldered on the back so these may remain loose / be removed throughout the project while adding other components.

## Screens
The first decision to make is whether you will be soldering against the pin headers of your screens or removing the pin headers (perhaps your screens don't have them pre-installed). Removing the pin headers will give you a more secure connection, however this is quite a painful task so I decided to leave them on and rely on the strength of the solder. If you want to remove them you should do so now. 

To install the screen we need to ensure we don't short the board against the aluminium enclosure, so we use plastic stand-off nuts. This means we have, bolt through the enclosure, onto a plastic stand-off, screen and then plastic standoff to secure the screen down. You repeat this for the 4 screen holes.

[Photo](screen_side.jpg)

If you need to install some upside down due to space / reverse them at a later stage while soldering this is actually ok. We can reverse them in the software.

## Switches
This is straight forward as the switches should have been threaded and come with their own washers/nuts. Use the second nut to set the height of the footswitch - make sure the switch circuit board does not sit directly against this nut. Get the nut fingertight on top of the enclosure and tighten with spanner (don't use too much force here).

## Arduino
The arduino will come with female pin headers for easy prototyping. For the most secure finish you should desolder these and solder wires straight onto the board. However I recommend doing this after the project is completely tested - we will use a more temporary solution through this tutorial allowing easy swappout of the arduino board if there are any issues / misconfiguration.

Like the screens you should use plastic stand-offs beneath the board and on top to secure it without shorting anything. I needed to use 2 between enclosure and board. You may find the gaps between pin headers are too small to rotate a nut, so use a screw-driver to tighten these. If any gaps are too small to even fit a nut, then see how secure the board is with the other holes locked down. You can always file down the plastic nuts to fit into the gaps as I did. [Photo](arduino_side.png)

## Other components
The other components will be similar to the footswitches - a simple matter of securing with provided nuts. The DIN sockets I used did require me to drill some holes and secure with screws. Just ensure you leave a bit of space between the components to make life easy when soldering these later.

# Electronics
[View the wiring](schematic_board.png)
The moral of this story is think hard about cable management and do a better job than me! I used shrink tube fairly extensively, I had planned on using brackets to run the wires in a neater way, but I didn't really leave enough wire length to make this work and didn't really want to redo the wiring.

You can import [schema](1-Schematic_PedalBoard.json) into EasyEda to modify as needed.

## Midi
Refer to [schematic](schematic_board.png) on how to wire this. 
* Solder wires onto the DIN socket according to schematic - the wires need to be long enough to reach the PCB, use all different colours and pass through shrink tube as a group to keep neat.
  * NOTE: We'll use 1 PCB for the midi connections and footswitches as there is plenty of space
* Use a multi-metre to test that none of the pins are connected to each other (have infinite resistance)
* Mount the resistors on the PCB board, the legs go through the holes and can be soldered in.
  * Leave a gap of 2 holes in between the resistors if mounting in a row
* Clip off the legs of the resistors so they don't short against anything
* Solder wires from DIN socket onto PCB
  * For the side that needs to connect to the Arduino I would recommend soldering in a pin header rather than a wire directly. This allows you to use dupont (female to female) to easily test
* On the back-side of the PCB solder in a [bridge](solder_bridge.png) between where you connected to wire, and the leg of resistor
* For the 3.3v midi lines you can bridge the 2 resistors (on the side connecting to arduino, not the side connecting to midi) and bridge this to a pin header to connect to arduino

[PCB frontside](midi_resistor.jpg)
[PCB backside](pcb_solder_bridge.jpg)
[Midi socket](midi_dc_in_2.jpg)

## Footswitch
Rather than connecting the footswitches directly to the arduino it is better to wire the footswitches to a PCB, this allows for using dupont cables for testing / changing pin numbers per switch easily
The ground will be bridged together so you have some options here. You can wire every footswitch to the PCB and then use a solder bridge across these and a pin header. The pin header can then be connected to the arduino easily. 
There will be many other components such as Midi, LED, screens that will all be bridged on ground as well so it's a good idea to have this happen on the PCB and then run 1 connection to the arduino.
If you want to save some wire you can daisy chain the switches together - for each row connect the grounds together in a line and then 1 wire per row onto the PCB to finally bridge and go to arduino.

The other terminal on the footswitch will correspond to a unique pin so can't be bridged. Solder in a pin header, wire each footswitch to the PCB hole next to each pin, then bridge from the back of the PCB - ensuring not to bridge any pins together.
You should use a multi-metre to test every pin forms a circuit when the switch is pressed. You should also check that none of the pin headers have continuity (infinite resistance).

### Connecting to arduino
There are a few pins that we can't use on the arduino as they interfere with SPI / have other purposes. D0/D1 are skipped purely because they can be used as additionaly Serial port. Pins 4, 8, 10, 14 should be left unconnected. So footswitch pins will be 3,5,6,7,8,11,12,13,22,23,24,25,26,27,28

Why?
- Pin 2 for PWM screen brightness
- Pin 4 Connected to MOSI SPI pin
- Pin 8 interferes with SPI reset
- Pin 9 controls led output
- Pin 10 is used for SPI slave mode

## Screens
The screens have 8 pins, of which only 1 is unique per screen (the CS pin). The rest will all be bridged together. In my design I wired every screen for 7 pins back to a PCB (separate PCB to the one used by footswitches + midi). This results in a grid of 15 (number of screens) x 7. The rows use a solder bridge and then a pin header at the end of the rows allowing a single connection per screen pin type back to the arduino. 

[PCB](screen_pcb.jpg)

However, I would recommend a different approach here. Daisy chain the screen rows together per pin type and then back to the PCB. This means you will only have 3 (number of rows) by 7 wires connecting to the PCB.

### Connecting to arduino
3 screen pins need to be connected to the SPI header on the board. See [location](spi_header.png):
Reset/RST => Reset
SCK => SCK
SDA => MOSI

The remaining screen pins:
BL => Digital Pin 2
AO => Digital Pin 53
CS => (digital pins 49-33 unique per screen, I left pins 50+ for other uses incuding the AO)
GND => Connect to any ground pin on arduino
VCC => Should connect to the 3.3v pin on arduino

NOTE: the screens can run on 5v as well, I believe this may increase brightness so am planning on experimenting with this.

## Expression
TODO

## LED
I have digital pin 29 assigned to a tempo LED.
* LEDs have polarity so you may need to reverse this circuit
* Twist and solder a 120 ohm resistor onto 1 leg of resistor and connect to pin 29, the other leg to connect to ground
  * Wire the ground to the footswitch PCB for easy central place for ground connections that are already bridged

Check the [schematic](schematic_board.png)
[Photo](led.jpg)

# Midi-Box
TODO: Details
[Schematic](schematic_midibox.png)
[Image](midi_box.jpg)

